<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ page.title | default: "Home" }} | {{ site.title }}</title>

  {% if site.description %}
    <meta name="description" content="{{ site.description }}"/>
  {% endif %}

  <link rel="stylesheet" href="{{ '/assets/css/style.scss' | relative_url }}" />

  <!-- Minimal inline style for the dark toggle button layout (keeps layout stable before CSS loads) -->
  <style>
    .dm-toggle { position: fixed; top: 18px; right: 18px; z-index: 999; }
  </style>
</head>
<body class="theme-light">

  <!-- Dark mode toggle -->
  <div class="dm-toggle">
    <button id="dmBtn" aria-label="Toggle dark mode">üåô</button>
  </div>

  <header class="hero">
  <div class="hero-inner">
    <img src="{{ '/assets/img/portrait.jpg' | relative_url }}" alt="Profile photo" class="hero-photo">

    <div class="hero-text">
      <h1>{{ site.title }}</h1>
      <p>{{ site.description }}</p>
    </div>
  </div>

  </header>

  <main class="container">
    {{ content }}

    <!-- Hacker Console Section -->
    <section id="projects" class="console-section">
      <h2 class="section-title">üì° Hacker Console ‚Äî pinned repos</h2>
      <div id="console" class="console" role="log" aria-live="polite">
        <div class="console-line">$ booting console...</div>
      </div>
      <div class="console-controls">
        <button id="refreshBtn" class="button tiny">Refresh</button>
        <span id="rateHint" class="muted"></span>
      </div>
    </section>

    <!-- Contact -->
    <section id="contact" class="contact">
      <h2>ü§ù Let's connect</h2>
      <p>If you want to work together or test a prototype, reach out: <a href="mailto:{{ site.contact_email }}">{{ site.contact_email }}</a></p>
      <p>Or find me on <a href="https://github.com/{{ site.github.repository_owner }}" target="_blank" rel="noopener">GitHub</a>.</p>
    </section>
  </main>

  <footer class="footer">
    ¬© {{ site.time | date: "%Y" }} {{ site.title }} ‚Ä¢ Built with ‚ù§Ô∏è
  </footer>

  <!-- ====== Scripts ====== -->
  <script>
    /* -------------------------
       Dark Mode Toggle
       - Saves preference in localStorage under "veyda_theme"
       - theme classes: theme-light | theme-dark
    --------------------------*/
    (function () {
      const THEME_KEY = 'veyda_theme';
      const root = document.documentElement || document.body;
      const btn = document.getElementById('dmBtn');

      function applyTheme(theme) {
        if (theme === 'dark') {
          document.body.classList.remove('theme-light');
          document.body.classList.add('theme-dark');
          btn.textContent = '‚òÄÔ∏è';
        } else {
          document.body.classList.remove('theme-dark');
          document.body.classList.add('theme-light');
          btn.textContent = 'üåô';
        }
      }

      // initialize from localStorage or system preference
      const saved = localStorage.getItem(THEME_KEY);
      if (saved) {
        applyTheme(saved);
      } else {
        // prefer dark for Midnight Minimal
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(prefersDark ? 'dark' : 'light');
      }

      btn.addEventListener('click', () => {
        const current = document.body.classList.contains('theme-dark') ? 'dark' : 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem(THEME_KEY, next);
        applyTheme(next);
      });
    })();
  </script>

  <script>
    /* -------------------------
       Hacker Console: Fetch pinned repos from GitHub REST API
       - Uses 'pinned_repos' from _config.yml, rendered into the page as data-attribute
       - Fetches details from api.github.com/repos/<owner>/<repo>
       - Renders a styled "console" output
    --------------------------*/

    (function () {
      const consoleEl = document.getElementById('console');
      const refreshBtn = document.getElementById('refreshBtn');
      const rateHint = document.getElementById('rateHint');

      // Render the pinned list from Jekyll config
      const pinned = [
        {% for item in site.pinned_repos %}
        "{{ item }}",
        {% endfor %}
      ].filter(Boolean);

      // Utility: append line to console
      function appendLine(text, cls) {
        const div = document.createElement('div');
        div.className = 'console-line' + (cls ? ' ' + cls : '');
        div.textContent = text;
        consoleEl.appendChild(div);
        // auto-scroll
        consoleEl.scrollTop = consoleEl.scrollHeight;
      }

      // Get rate limit info
      async function fetchRateLimit() {
        try {
          const res = await fetch('https://api.github.com/rate_limit');
          if (!res.ok) return null;
          return res.json();
        } catch (e) {
          return null;
        }
      }

      // Fetch single repo data
      async function fetchRepo(fullName) {
        const url = `https://api.github.com/repos/${fullName}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`);
        return resp.json();
      }

      // Render a repo card line in console style
      function renderRepoLine(repo) {
        // Example formatted line:
        // $ repo: draftfodge ‚Äî AI writing tool | ‚òÖ 12 | JS | https://github.com/...
        const name = repo.full_name.split('/')[1];
        const stars = repo.stargazers_count || 0;
        const lang = repo.language || '‚Äî';
        return `$ repo: ${name} ‚Äî ${repo.description ? repo.description : 'No description'} | ‚òÖ ${stars} | ${lang} | ${repo.html_url}`;
      }

      // Main: fetch all pinned repos sequentially (to be gentle on rate limits)
      async function loadPinned() {
        consoleEl.innerHTML = ''; // clear
        appendLine('$ initializing fetch for pinned repos...', 'muted');
        if (!pinned.length) {
          appendLine('$ no pinned repos configured. Edit _config.yml > pinned_repos', 'error');
          return;
        }

        // show rate limit if available
        const rl = await fetchRateLimit();
        if (rl && rl.resources && rl.resources.core) {
          const remaining = rl.resources.core.remaining;
          rateHint.textContent = `GitHub API remaining requests: ${remaining}`;
        } else {
          rateHint.textContent = '';
        }

        for (let i = 0; i < pinned.length; i++) {
          const slug = pinned[i];
          appendLine(`$ [${i+1}/${pinned.length}] fetching ${slug} ...`, 'info');
          try {
            const repo = await fetchRepo(slug);
            appendLine(renderRepoLine(repo), 'repo');
            // small delay between calls to reduce burst
            await new Promise(r => setTimeout(r, 400));
          } catch (err) {
            appendLine(`$ ERROR fetching ${slug}: ${err.message}`, 'error');
          }
        }
        appendLine('$ done.', 'done');
      }

      refreshBtn.addEventListener('click', () => {
        loadPinned();
      });

      // initial load
      loadPinned();
    })();
  </script>

</body>
</html>
